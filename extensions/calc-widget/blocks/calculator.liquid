<div class="calccart-widget" data-product-id="{{ product.id }}" style="
  border: 2px solid {{ block.settings.border_color }};
  border-radius: 8px;
  padding: 16px;
  margin: 16px 0;
  background: {{ block.settings.bg_color }};
">
  <h3 style="margin: 0 0 12px 0; font-size: 16px; font-weight: bold;">
    {{ block.settings.title }}
  </h3>
  
  <div style="margin-bottom: 12px;">
    <label style="display: block; margin-bottom: 4px; font-weight: 500;">
      {{ block.settings.input_label }}
    </label>
    <input 
      type="number" 
      id="calccart-input-{{ product.id }}"
      min="0.1" 
      step="0.1" 
      placeholder="e.g. 25"
      style="
        width: 100%;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 6px;
        font-size: 16px;
      "
    >
  </div>
  
  <div id="calccart-result-{{ product.id }}" style="
    background: #f0f9f0;
    padding: 12px;
    border-radius: 6px;
    margin-bottom: 12px;
    display: none;
  ">
    <p style="margin: 0; font-size: 14px;">
      <strong>{{ block.settings.result_label }}</strong> 
      <span id="calccart-quantity-{{ product.id }}">-</span> {{ block.settings.unit_label }}
    </p>
    <p style="margin: 4px 0 0 0; font-size: 12px; color: #666;">
      (incl. <span id="calccart-waste-{{ product.id }}">10</span>% {{ block.settings.waste_label }})
    </p>
  </div>
  
  <button 
    id="calccart-add-{{ product.id }}"
    type="button"
    disabled
    style="
      width: 100%;
      padding: 12px;
      background: {{ block.settings.button_color }};
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      opacity: 0.5;
    "
  >
    {{ block.settings.button_text }}
  </button>
</div>

<script>
(function() {
  const productId = "{{ product.id }}";
  const variantId = "{{ product.selected_or_first_available_variant.id }}";
  const input = document.getElementById("calccart-input-" + productId);
  const result = document.getElementById("calccart-result-" + productId);
  const quantitySpan = document.getElementById("calccart-quantity-" + productId);
  const wasteSpan = document.getElementById("calccart-waste-" + productId);
  const addButton = document.getElementById("calccart-add-" + productId);

  const coverage = {{ block.settings.coverage | default: 6 }};
  const wastePercent = {{ block.settings.waste_percent | default: 10 }};
  const wasteFactor = 1 + (wastePercent / 100);
  const successMsg = "{{ block.settings.success_message }}";
  
  wasteSpan.textContent = wastePercent;
  
  let calculatedQuantity = 0;
  
  input.addEventListener("input", function() {
    const area = parseFloat(this.value);
    
    if (area > 0 && coverage > 0) {
      calculatedQuantity = Math.ceil((area / coverage) * wasteFactor);
      quantitySpan.textContent = calculatedQuantity;
      result.style.display = "block";
      addButton.disabled = false;
      addButton.style.opacity = "1";
    } else {
      result.style.display = "none";
      addButton.disabled = true;
      addButton.style.opacity = "0.5";
      calculatedQuantity = 0;
    }
  });
  
  addButton.addEventListener("click", function() {
    if (calculatedQuantity > 0) {
      fetch("/cart/add.js", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          id: variantId,
          quantity: calculatedQuantity
        })
      })
      .then(response => response.json())
      .then(data => {
        alert(calculatedQuantity + " " + successMsg);
        window.location.href = "/cart";
      })
      .catch(error => {
        alert("Error adding to cart");
        console.error(error);
      });
    }
  });
})();
</script>

{% schema %}
{
  "name": "CalcCart Calculator",
  "target": "section",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Widget Title",
      "default": "Quantity Calculator"
    },
    {
      "type": "text",
      "id": "input_label",
      "label": "Input Label",
      "default": "Enter area in sqm:"
    },
    {
      "type": "text",
      "id": "result_label",
      "label": "Result Label",
      "default": "Required quantity:"
    },
    {
      "type": "text",
      "id": "unit_label",
      "label": "Unit Label",
      "default": "units"
    },
    {
      "type": "text",
      "id": "waste_label",
      "label": "Waste Label",
      "default": "waste"
    },
    {
      "type": "text",
      "id": "button_text",
      "label": "Button Text",
      "default": "Add to Cart"
    },
    {
      "type": "text",
      "id": "success_message",
      "label": "Success Message",
      "default": "items added to cart!"
    },
    {
      "type": "number",
      "id": "coverage",
      "label": "Coverage (1 unit covers X)",
      "default": 6
    },
    {
      "type": "range",
      "id": "waste_percent",
      "label": "Waste %",
      "min": 0,
      "max": 30,
      "step": 5,
      "default": 10,
      "unit": "%"
    },
    {
      "type": "color",
      "id": "bg_color",
      "label": "Background Color",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "border_color",
      "label": "Border Color",
      "default": "#e0e0e0"
    },
    {
      "type": "color",
      "id": "button_color",
      "label": "Button Color",
      "default": "#008060"
    }
  ]
}
{% endschema %}